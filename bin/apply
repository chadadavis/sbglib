#!/usr/bin/env perl

use strict;

use File::Basename;
use SBG::Domain;
use SBG::DomainIO;
use SBG::STAMP;
use SBG::CofM;

my ($tfile, @files) = @ARGV;
die unless $tfile;
my $io = new SBG::DomainIO(-file=>$tfile);
my $dom = $io->read;
my $t = $dom->transformation;
print "$tfile:\n$t\n";

foreach my $file (@files) {
    my @doms;
    my $io = new SBG::DomainIO(-file=>$file);
    $file = file_incr($file);
    print STDERR "$file :\n";

    while (my $d = $io->read) {
        # Make sure points are defined in space first
        $d = SBG::CofM::cofm($d);
        # Apply any saved transformation to native CofM point
        $d->transform($d->transformation);

        my $label = label_incr($d->label);
        $d->label($label);
        print STDERR "\t$d\n";
        $d->transform($t);
        push @doms, $d;
    }
    $io->close;
    $io = new SBG::DomainIO(-file=>">$file");
    foreach my $d (@doms) {
        $io->write($d,-id=>'stampid');
    }
}

# Add a counter to file name to track number of times transformed
sub file_incr {
    my $file = shift;
    if ($file =~ /^(.*?)(\d+)?(\..*)?$/) {
        $file = $1 . ($2+1) . $3;
    }
    return $file;
}

# Add a counter to domain name to track number of times transformed
sub label_incr {
    my $label = shift;
    my $n = 0;
    if ($label =~ /^(.*?)-?t(\d+)$/) {
        $n = $2;
        $label = $1;
    }
    $n++;
    $label = ($label ? $label . '-t' : 't') . sprintf("%03d",$n);
    return $label;
}

    
__END__



